# handlers/commands.py
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton

from ai_responder.responder import user_device, sessions

router = Router()

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π UX ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –∫–æ–º–ø–∞–∫—Ç–Ω–æ)
device_keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω"), KeyboardButton(text="üíª –ö–æ–º–ø—å—é—Ç–µ—Ä")]
    ],
    resize_keyboard=True,
    one_time_keyboard=True
)


@router.message(Command("start"))
async def cmd_start(msg: Message):
    """
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏ /start ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    –∏ –ø—Ä–æ—Å–∏–º –≤—ã–±—Ä–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–¥–æ–±–Ω—ã–º –≤–∏–∑—É–∞–ª—å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.
    """
    user = msg.from_user.id

    # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é ‚Äî –∏—Å—Ç–æ—Ä–∏—è, pending, device –∏ —Ñ–ª–∞–≥ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    sessions.clear(user)
    user_device.pop(user, None)

    await msg.answer(
        "<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b> üòä\n\n"
        "–Ø ‚Äî <b>Dodo AI Assistant</b>, –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–∞–π—Ç–∞.\n\n"
        "–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ, —Å –∫–∞–∫–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤—ã —Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å–µ—Ä–≤–∏—Å:\n\n"
        "üì± <b>–°–º–∞—Ä—Ç—Ñ–æ–Ω</b>\nüíª <b>–ö–æ–º–ø—å—é—Ç–µ—Ä</b>\n\n"
        "–ù–∞–∂–º–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ ¬´–°–º–∞—Ä—Ç—Ñ–æ–Ω¬ª / ¬´–ö–æ–º–ø—å—é—Ç–µ—Ä¬ª.",
        reply_markup=device_keyboard,
        parse_mode="HTML",
    )


@router.message(Command("help"))
async def cmd_help(msg: Message):
    """–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º –±–æ—Ç–∞."""
    await msg.answer(
        "<b>–°–ø—Ä–∞–≤–∫–∞</b>\n\n"
        "‚Ä¢ –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ä–∞–±–æ—Ç–µ —Å–∞–π—Ç–∞ (–≤—ã–≤–æ–¥, –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è, –ø–ª–∞—Ç–µ–∂–∏, –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ç.–¥.).\n"
        "‚Ä¢ –ß—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ¬´–°–º–∞—Ä—Ç—Ñ–æ–Ω¬ª / ¬´–ö–æ–º–ø—å—é—Ç–µ—Ä¬ª.\n"
        "‚Ä¢ –î–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/reset</code>.\n\n"
        "–Ø –æ—Ç–≤–µ—á–∞—é –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. –ï—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–∂—É –æ—Ç–≤–µ—Ç ‚Äî –ø–æ–ø—Ä–æ—à—É —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏.",
        parse_mode="HTML",
    )


@router.message(Command("reset"))
async def cmd_reset(msg: Message):
    """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user = msg.from_user.id
    sessions.clear(user)
    user_device.pop(user, None)
    await msg.answer(
        "‚úÖ –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω–∞. –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:",
        reply_markup=device_keyboard
    )
